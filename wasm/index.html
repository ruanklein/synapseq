<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SynapSeq WASM</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 900px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 2.5rem;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 0.95rem;
      }

      .editor-section {
        margin-bottom: 20px;
        display: flex;
        gap: 0;
      }

      .line-numbers {
        background: #f5f5f5;
        border: 2px solid #e0e0e0;
        border-right: none;
        border-radius: 8px 0 0 8px;
        padding: 20px 10px;
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
        line-height: 1.6;
        color: #999;
        text-align: right;
        user-select: none;
        min-width: 50px;
        overflow-y: hidden;
        overflow-x: hidden;
        white-space: pre;
      }

      textarea {
        flex: 1;
        min-height: 400px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-left: 1px solid #e0e0e0;
        border-radius: 0 8px 8px 0;
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
        line-height: 1.6;
        resize: vertical;
        transition: border-color 0.3s;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea:focus + .line-numbers,
      .editor-section:focus-within .line-numbers {
        border-color: #667eea;
      }

      textarea:disabled {
        background: #fafafa;
        cursor: not-allowed;
      }

      .error-container {
        display: none;
        background: #fee;
        border: 2px solid #fcc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #c33;
      }

      .error-container.visible {
        display: block;
      }

      .error-title {
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .error-message {
        font-family: "Courier New", Courier, monospace;
        font-size: 13px;
        white-space: pre-wrap;
      }

      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-play {
        background: #667eea;
        color: white;
        flex: 1;
      }

      .btn-play:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-stop {
        background: #ef4444;
        color: white;
        flex: 1;
      }

      .btn-stop:hover:not(:disabled) {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }

      .btn-upload {
        background: #10b981;
        color: white;
        flex: 1;
      }

      .btn-upload:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }

      .status {
        text-align: center;
        color: #666;
        font-size: 14px;
        padding: 10px;
        border-radius: 8px;
        background: #f5f5f5;
      }

      .status.loading {
        color: #667eea;
        background: #eef2ff;
      }

      .status.error {
        color: #c33;
        background: #fee;
      }

      .status.success {
        color: #059669;
        background: #d1fae5;
      }

      input[type="file"] {
        display: none;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 2rem;
        }

        textarea {
          min-height: 300px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>SynapSeq</h1>
      <p class="subtitle">
        Create and play binaural beats and isochronic tones
      </p>

      <div class="editor-section">
        <div class="line-numbers" id="lineNumbers"></div>
        <textarea
          id="spsqEditor"
          placeholder="Enter your SPSQ code here or upload a file..."
        >
# A sample isochronic sequence

# Presets
alpha-one
  noise pink amplitude 30
  tone 250 isochronic 8 amplitude 15

alpha-two
  noise pink amplitude 25
  tone 250 isochronic 9 amplitude 15

alpha-three
  noise pink amplitude 20
  tone 250 isochronic 10 amplitude 15

alpha-four
  noise pink amplitude 15
  tone 250 isochronic 11 amplitude 15

# Timeline
00:00:00 silence
00:00:15 alpha-one
00:01:00 alpha-one
00:02:30 alpha-two
00:04:00 alpha-three
00:05:30 alpha-four
00:07:00 silence</textarea
        >
      </div>

      <div class="error-container" id="errorContainer">
        <div class="error-title">Error</div>
        <div class="error-message" id="errorMessage"></div>
      </div>

      <div class="controls">
        <button class="btn-play" id="playBtn" onclick="handlePlay()">
          Play
        </button>
        <button class="btn-stop" id="stopBtn" onclick="handleStop()" disabled>
          Stop
        </button>
        <button
          class="btn-upload"
          id="uploadBtn"
          onclick="document.getElementById('fileInput').click()"
        >
          Upload
        </button>
        <input
          type="file"
          id="fileInput"
          accept=".spsq,.json"
          onchange="handleFileUpload(event)"
        />
      </div>

      <div class="status" id="status">Ready</div>
    </div>

    <script src="synapseq.js"></script>
    <script>
      let synapseq = null;

      // Initialize line numbers
      function updateLineNumbers() {
        const textarea = document.getElementById("spsqEditor");
        const lineNumbers = document.getElementById("lineNumbers");
        const lines = textarea.value.split("\n").length;

        const numbers = [];
        for (let i = 1; i <= lines; i++) {
          numbers.push(i);
        }
        lineNumbers.textContent = numbers.join("\n");
      }

      // Initialize SynapSeq library
      async function initSynapSeq() {
        synapseq = new SynapSeq();

        // Setup event handlers
        synapseq.onloaded = () => {};

        synapseq.ongenerating = () => {
          setStatus("Generating audio...", "loading");
          document.getElementById("playBtn").disabled = true;
          document.getElementById("uploadBtn").disabled = true;
          document.getElementById("spsqEditor").disabled = true;
        };

        synapseq.onplaying = () => {
          const sampleRate = synapseq.getSampleRate();
          setStatus(`Playing (${sampleRate} Hz)`, "success");
          document.getElementById("playBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
          document.getElementById("uploadBtn").disabled = true;
          document.getElementById("spsqEditor").disabled = true;
        };

        synapseq.onstopped = () => {
          setStatus("Stopped", "success");
          document.getElementById("playBtn").disabled = false;
          document.getElementById("stopBtn").disabled = true;
          document.getElementById("uploadBtn").disabled = false;
          document.getElementById("spsqEditor").disabled = false;
        };

        synapseq.onended = () => {
          setStatus("Playback finished", "success");
          synapseq.stop();
        };

        synapseq.onerror = (detail) => {
          showError(detail.error.message || detail.error);
          setStatus("Error", "error");
          document.getElementById("playBtn").disabled = false;
          document.getElementById("uploadBtn").disabled = false;
          document.getElementById("spsqEditor").disabled = false;
        };

        // Wait for worker to be ready
        const checkReady = setInterval(() => {
          if (synapseq.isReady()) {
            clearInterval(checkReady);
            setStatus("Ready", "success");
            updateLineNumbers();
          }
        }, 100);
      }

      // Initialize on load
      setStatus("Loading WASM...", "loading");
      initSynapSeq();

      // Update line numbers on input
      document.addEventListener("DOMContentLoaded", () => {
        const textarea = document.getElementById("spsqEditor");
        textarea.addEventListener("input", updateLineNumbers);
        textarea.addEventListener("scroll", () => {
          document.getElementById("lineNumbers").scrollTop = textarea.scrollTop;
        });
        updateLineNumbers();
      });

      function setStatus(message, type = "") {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;
        statusEl.className = "status" + (type ? " " + type : "");
      }

      function showError(message) {
        const errorContainer = document.getElementById("errorContainer");
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorContainer.classList.add("visible");
      }

      function hideError() {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.classList.remove("visible");
      }

      function detectFormat(content) {
        // Try to parse as JSON
        const trimmed = content.trim();
        if (trimmed.startsWith("{")) {
          try {
            JSON.parse(trimmed);
            return "json";
          } catch (e) {
            // Not valid JSON, treat as text
          }
        }
        return "text";
      }

      async function handlePlay() {
        if (!synapseq || !synapseq.isReady()) {
          setStatus("WASM not initialized yet", "error");
          return;
        }

        hideError();

        try {
          const content = document.getElementById("spsqEditor").value;

          if (!content.trim()) {
            showError("Please enter SPSQ code or upload a file");
            setStatus("Ready", "success");
            return;
          }

          // Detect format automatically
          const format = detectFormat(content);

          // Always reload the sequence to ensure we use the current textarea content
          await synapseq.load(content, format);

          // Play the sequence
          await synapseq.play();
        } catch (error) {
          showError(error.message || "Unknown error occurred");
          setStatus("Error", "error");
          document.getElementById("uploadBtn").disabled = false;
        }
      }

      function handleStop() {
        if (!synapseq) return;

        synapseq.stop();
      }

      async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file extension
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith(".spsq") && !fileName.endsWith(".json")) {
          showError("Invalid file type. Please upload a .spsq or .json file");
          event.target.value = "";
          return;
        }

        hideError();

        try {
          // Read file content first to detect format
          const reader = new FileReader();
          reader.onload = async (e) => {
            const content = e.target.result;
            const format = detectFormat(content);

            try {
              await synapseq.load(content, format);
              document.getElementById("spsqEditor").value = content;
              updateLineNumbers();
              setStatus(`File loaded: ${file.name} (${format})`, "success");
            } catch (error) {
              showError("Failed to load file: " + error.message);
              setStatus("File read error", "error");
            }
          };
          reader.readAsText(file);
        } catch (error) {
          showError("Failed to read file: " + error.message);
          setStatus("File read error", "error");
        }

        // Reset input so the same file can be uploaded again
        event.target.value = "";
      }
    </script>
  </body>
</html>
